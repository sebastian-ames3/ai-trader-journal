generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Entry types for journal entries
enum EntryType {
  TRADE_IDEA    // Pre-trade thoughts and analysis
  TRADE         // Actual executed trade (links to Trade model)
  REFLECTION    // Post-trade analysis and lessons learned
  OBSERVATION   // General market observations and notes
}

// Trader's emotional state when creating entry
enum EntryMood {
  CONFIDENT
  NERVOUS
  EXCITED
  UNCERTAIN
  NEUTRAL
}

// Conviction level for trade ideas and analysis
enum ConvictionLevel {
  LOW
  MEDIUM
  HIGH
}

// Capture method for journal entries (Phase 2 - Frictionless Capture)
enum CaptureMethod {
  TEXT            // Traditional typed entry
  VOICE           // Voice memo with transcription
  SCREENSHOT      // Image/screenshot with AI analysis
  QUICK_CAPTURE   // Quick text with auto-inference
}

model Trade {
  id              String    @id @default(cuid())
  ticker          String
  strategy        String
  status          String    @default("open")
  entryDate       DateTime  @default(now())
  exitDate        DateTime?

  legs            Json
  entryPrice      Float
  exitPrice       Float?
  contracts       Int

  accountSize     Float
  riskPercentage  Float
  maxLoss         Float

  iv              Float
  hv20            Float
  hv30            Float
  ivHvRatio       Float

  underlyingPrice Float
  volume          Int
  openInterest    Int
  bidAskSpread    Float

  rationale       String?
  marketRegime    String?

  // Options-specific fields (Issue #50)
  expirationDate  DateTime?  // Option expiration date
  strikePrice     Float?     // Primary strike (or lowest strike for multi-leg)
  optionType      String?    // 'CALL' or 'PUT' (null for multi-leg)

  // Entry price tracking for P/L calculation (Issue #55)
  entryPrices     Json?      // Array of {legId, price, timestamp} for each leg
  currentPrices   Json?      // Current market prices (updated daily)
  currentPL       Float?     // Cached unrealized P/L
  currentPLPercent Float?    // Cached P/L percentage
  lastPriceUpdate DateTime?  // When prices were last updated

  // Exit price tracking
  exitPrices      Json?      // Array of {legId, price, timestamp} for exit
  realizedPL      Float?     // Final P/L when closed

  notes           Note[]
  tags            Tag[]     @relation("TradeTags")
  snapshot        Snapshot?
  entries         Entry[]   // Journal entries related to this trade

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ticker])
  @@index([entryDate(sort: Desc)])
  @@index([status])
  @@index([expirationDate])
}

model Note {
  id        String   @id @default(cuid())
  content   String
  type      String   @default("general")

  tradeId   String?
  trade     Trade?   @relation(fields: [tradeId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tradeId])
}

model Tag {
  id      String   @id @default(cuid())
  name    String   @unique
  trades  Trade[]  @relation("TradeTags")
  entries Entry[]  @relation("EntryTags")
}

// Journal Entry model - standalone entries that can optionally link to trades
model Entry {
  id       String   @id @default(cuid())

  // Entry classification
  type     EntryType

  // Core content (Phase 1)
  content  String   @db.Text  // Main journal text, supports full-text search
  mood     EntryMood?
  conviction ConvictionLevel?

  // Optional associations
  ticker   String?  // Optional ticker symbol - entries don't require a ticker

  // Relationships
  tradeId     String?    // Optional link to Trade (null if Trade deleted)
  trade       Trade?     @relation(fields: [tradeId], references: [id], onDelete: SetNull)

  snapshotId  String?    @unique  // Optional link to market conditions snapshot
  snapshot    Snapshot?  @relation(fields: [snapshotId], references: [id], onDelete: SetNull)

  tags        Tag[]      @relation("EntryTags")

  // Ticker mentions (Phase 2 - Context Surfacing)
  tickerMentions TickerMention[]

  // Media fields (Phase 2 - Frictionless Capture)
  audioUrl      String?        // Voice note URL (Cloudflare R2)
  audioDuration Int?           // Duration in seconds
  transcription String?   @db.Text  // Whisper transcription of voice note
  imageUrls     String[]       // Screenshot URLs (Cloudflare R2)
  imageAnalyses Json?          // GPT-4o vision analysis results
  captureMethod CaptureMethod  @default(TEXT)  // How the entry was captured

  // AI analysis fields (Phase 2 - Issue #20)
  sentiment          String?    // AI-detected sentiment: positive/negative/neutral
  emotionalKeywords  String[]   // AI-extracted emotional keywords
  detectedBiases     String[]   // AI-identified cognitive biases
  aiTags             String[]   // AI-generated tags
  convictionInferred ConvictionLevel?  // AI-inferred conviction vs user-selected

  // Timestamps
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Indexes for common query patterns
  @@index([type])
  @@index([ticker])
  @@index([createdAt(sort: Desc)])
  @@index([mood])
  @@index([conviction])
  @@index([tradeId])
}

model Snapshot {
  id           String   @id @default(cuid())
  tradeId      String   @unique
  trade        Trade    @relation(fields: [tradeId], references: [id])

  price      Float?    // Underlying price at snapshot
  volume     Int?      // Volume
  openInterest Int?    // Open interest

  marketData   Json
  greeks       Json?
  chainData    Json
  hv20        Float?    // 20-day historical volatility
  hv30        Float?    // 30-day historical volatility
  hvSource    String?   // Data source (e.g., "yfinance")
  newsEvents   Json?
  calcAt      DateTime? // When HV was calculated

  iv         Float?    // Implied volatility as decimal (0.285 = 28.5%)
  ivTermDays Int?      // Term in days, default 30
  ivSource   String?   // Source of IV data, default "manual"
  ivAt       DateTime? // When IV was recorded

  entry        Entry?    // Optional link back to journal entry

  capturedAt   DateTime @default(now())
}

model Settings {
  id                String   @id @default("default")
  defaultRisk       Float    @default(1.0)
  accountSize       Float    @default(10000)
  liquidityThreshold Float   @default(100)
  ivThreshold       Float    @default(80)

  // Journaling streak tracking (Issue #34)
  currentStreak     Int      @default(0)    // Consecutive days with â‰¥1 entry
  longestStreak     Int      @default(0)    // All-time best streak
  totalEntries      Int      @default(0)    // Total entry count
  lastEntryDate     DateTime?              // Last entry date for streak calculation
  lastGraceDate     DateTime?              // Last grace day used (for 1-day forgiveness)

  updatedAt         DateTime @updatedAt
}

// ============================================
// Proactive Engagement Models (Phase 2)
// ============================================

// Notification type categories
enum NotificationType {
  MARKET_CONDITION    // Market down/up alerts
  TICKER_MOVE         // User's mentioned tickers move
  TIME_BASED          // Daily/weekly prompts
  JOURNAL_NUDGE       // Silence detection
  HISTORICAL_CONTEXT  // Similar past entry surfacing
}

// Market state classification
enum MarketState {
  UP        // SPY > +1%
  DOWN      // SPY < -1%
  FLAT      // -1% to +1%
  VOLATILE  // VIX > 25 or |SPY| > 2%
}

// Push notification subscriptions
model PushSubscription {
  id        String   @id @default(cuid())
  endpoint  String   @unique
  keys      Json     // { p256dh: string, auth: string }
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([endpoint])
}

// User notification preferences
model UserNotificationPrefs {
  id                  String  @id @default("default")

  // Market alerts
  marketAlerts        Boolean @default(true)   // Big market moves
  vixAlerts           Boolean @default(true)   // VIX spikes
  tickerAlerts        Boolean @default(true)   // User's tickers move

  // Time-based prompts
  dailyReflection     Boolean @default(true)
  dailyReflectionTime String  @default("16:30") // ET
  weeklyReview        Boolean @default(true)
  tradeIdeaFollowups  Boolean @default(true)

  // Journal nudges
  journalNudgeDays    Int     @default(7)      // Days of silence before nudge

  // Quiet hours (no notifications)
  quietHoursStart     String  @default("21:00")
  quietHoursEnd       String  @default("07:00")

  updatedAt           DateTime @updatedAt
}

// Notification log for tracking engagement
model NotificationLog {
  id         String           @id @default(cuid())
  type       NotificationType
  trigger    String           // "market_down_2pct", "vix_spike", etc.
  title      String
  body       String
  data       Json?            // Additional context
  sentAt     DateTime         @default(now())
  engagedAt  DateTime?        // When user clicked/responded
  dismissed  Boolean          @default(false)
  snoozedTo  DateTime?        // If snoozed, when to remind again

  @@index([type])
  @@index([sentAt(sort: Desc)])
}

// Daily market conditions snapshot
model MarketCondition {
  id          String      @id @default(cuid())
  date        DateTime    @unique
  spyPrice    Float
  spyChange   Float       // Daily percentage change
  qqqPrice    Float?
  qqqChange   Float?
  vixLevel    Float
  vixChange   Float?      // Daily change in VIX
  marketState MarketState

  createdAt   DateTime    @default(now())

  @@index([date(sort: Desc)])
  @@index([marketState])
}

// ============================================
// Pattern Recognition Models (Phase 2)
// ============================================

// Types of behavioral patterns
enum PatternType {
  TIMING           // Early exits, late entries, etc.
  CONVICTION       // Conviction patterns over time
  EMOTIONAL        // Emotional response patterns
  MARKET_CONDITION // Behavior during specific market conditions
  STRATEGY         // Strategy-related patterns
  BIAS_FREQUENCY   // Recurring cognitive biases
}

// Pattern trend direction
enum Trend {
  INCREASING  // Pattern becoming more frequent
  STABLE      // Pattern frequency unchanged
  DECREASING  // Pattern becoming less frequent
}

// Detected behavioral patterns
model PatternInsight {
  id              String      @id @default(cuid())
  patternType     PatternType
  patternName     String      // "fomo_trading", "drawdown_silence", etc.
  description     String      @db.Text
  occurrences     Int         // Number of times pattern detected
  trend           Trend       // Is pattern increasing/decreasing?
  confidence      Float       // 0-1 confidence score
  relatedEntryIds String[]    // IDs of entries that form this pattern
  evidence        String[]    // Quotes/excerpts from entries
  outcomeData     Json?       // { winRate, avgReturn, etc. }
  firstDetected   DateTime    @default(now())
  lastUpdated     DateTime    @default(now())
  isActive        Boolean     @default(true)
  isDismissed     Boolean     @default(false)

  @@index([patternType])
  @@index([patternName])
  @@index([isActive])
  @@index([lastUpdated(sort: Desc)])
}

// ============================================
// Context Surfacing Models (Phase 2)
// ============================================

// Track ticker mentions in entries for quick lookup
model TickerMention {
  id        String   @id @default(cuid())
  ticker    String   // Normalized ticker symbol (uppercase)
  entryId   String
  createdAt DateTime @default(now())

  entry     Entry    @relation(fields: [entryId], references: [id], onDelete: Cascade)

  @@index([ticker])
  @@index([entryId])
  @@index([ticker, createdAt(sort: Desc)])
}

// Cache market snapshots for historical context
model MarketSnapshot {
  id        String   @id @default(cuid())
  ticker    String
  date      DateTime // Date of snapshot (day granularity)
  price     Float
  change    Float    // Percentage change
  volume    Float?
  iv        Float?   // Implied volatility
  hv20      Float?   // 20-day historical volatility
  ivRank    Float?   // IV rank (0-100)
  high52w   Float?   // 52-week high
  low52w    Float?   // 52-week low

  createdAt DateTime @default(now())

  @@unique([ticker, date])
  @@index([ticker])
  @@index([date(sort: Desc)])
}
